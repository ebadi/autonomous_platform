<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Hamid Ebadi @ Infotiv" /><link rel="canonical" href="https://infotiv-research.github.io/autonomous_platform/CAN_Nodes_Microcontroller_Code/Shared_HW_Node_Libraries/PropulsionInterface/documentation_and_research/" />
      <link rel="shortcut icon" href="../../../../img/favicon.ico" />
    <title>Index - Autonomous Platform Generation 4</title>
    <link rel="stylesheet" href="../../../../css/theme.css" />
    <link rel="stylesheet" href="../../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Index";
        var mkdocs_page_input_path = "CAN_Nodes_Microcontroller_Code/Shared_HW_Node_Libraries/PropulsionInterface/documentation_and_research/README.md";
        var mkdocs_page_url = "/autonomous_platform/CAN_Nodes_Microcontroller_Code/Shared_HW_Node_Libraries/PropulsionInterface/documentation_and_research/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/c.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../../.." class="icon icon-home"> Autonomous Platform Generation 4
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">High Level overview</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../..">Autonomous Platform Generation 4</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../CHANGELOG/">Changelog</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../HARDWARE_DESIGN/">Hardware Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../SOFTWARE_DESIGN/">Software Design</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../HOW_TO_EXTEND/">How to Extend</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">CAN Nodes and Microcontroller</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../">CAN Nodes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../Propulsion_Steering/">Propulsion Steering</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../Speed_Sensor/">Speed Sensor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../HOW_TO_EXTEND/">How to Extend</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../CAN_LIBRARY_DATABASE/">CAN library</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Hardware Interface Low Level Computer</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../Hardware_Interface_Low_Level_Computer/">Hardware Interface Low Level Computer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../Hardware_Interface_Low_Level_Computer/HOW_TO_EXTEND/">How to Extend</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../Hardware_Interface_Low_Level_Computer/SETUP_OF_RASPBERRY_PI/">Setting up RaspberryPi</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">High Level Control Computer</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../High_Level_Control_Computer/">High Level Control Computer</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="../../../../High_Level_Control_Computer/HOW_TO_EXTEND.md">How to Extend</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../High_Level_Control_Computer/IMITATION_LEARNING/">Imitation Learning</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../High_Level_Control_Computer/DONKEY_CAR_SETUP/">DonkeyCar simulator</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../High_Level_Control_Computer/DIGITAL_TWIN_ROS/">Digital Twins in ROS</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Power Unit</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../Power_Unit/">Power Unit</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Issues and Future work</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../ISSUES_AND_FUTURE_WORK/">Issues and Future work</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">CAD designs</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../CAD/">Images</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Test & Debugging</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../TEST_DEBUGGING/">Basics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../Hardware_Interface_Low_Level_Computer/TEST_DEBUGGING/">Hardware_Interface_Low_Level_Computer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../High_Level_Control_Computer/TEST_DEBUGGING/">High_Level_Control_Computer</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../..">Autonomous Platform Generation 4</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Index</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/infotiv-research/autonomous_platform/edit/master/docs/CAN_Nodes_Microcontroller_Code/Shared_HW_Node_Libraries/PropulsionInterface/documentation_and_research/README.md">Edit on infotiv-research/autonomous_platform</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="propulsion-control-of-ninebot">Propulsion Control of Ninebot</h2>
<pre><code class="language-bash">  Segway_Propulsion
 ┣  Images
    Pictures of results/used for documentation
 ┣  Manuals
    User Manuals for all hardware mentioned/used
 ┣  Test_Rig
    Arduino code for reading pedals
    Arduino code for running the test rig set up    
</code></pre>
<h3 id="analysis-on-ninebot-gokart-kit">Analysis on Ninebot Gokart kit</h3>
<p>In order to develop an appropriate propulsion method for the next generation, it was needed to analyse the gokart kit and understand how it works. The pedals are connected to the kit-cricuit and sends analog readings to it. Then the kit-circuit convert these pure voltage reading and sents it through a 2 wires that makes up the serial communication between the kit and segway hoverboard.</p>
<p>The hall sensor under the pedals. It is connected through [GND,V_in,V_out].</p>
<p><img alt="Resources/Hall_sensor.jpg" src="Resources/Hall_sensor.jpg" /></p>
<table>
<thead>
<tr>
<th>Accelerate Pedal</th>
<th>Brake Pedal</th>
</tr>
</thead>
<tbody>
<tr>
<td>GND (black)</td>
<td>GND (black)</td>
</tr>
<tr>
<td>V_in (red)</td>
<td>V_in (red)</td>
</tr>
<tr>
<td>V_out (white) [0.82-4.35] V</td>
<td>V_out (brown)      [0.84-4.33] V</td>
</tr>
</tbody>
</table>
<p><img alt="Resources/pedal_cables.jpg" src="Resources/pedal_cables.jpg" /></p>
<p>From these cables we managed to hotwire in order to read the pedals sensor readings through using a arduino nan  (Arduino code can be found in <em>\Segway_Propulsion\Test_Rig\ReadBrakePedals</em>) and according to the setup illustrated below:</p>
<p><img alt="Resources/readings.jpg" src="Resources/readings.jpg" /></p>
<p>Even tough a bit blurry but it can be seen how the sensor readings look like. Where the blue line correspond to the accelerator and red to the brake pedal.</p>
<p><img alt="Resources/Plots.PNG" src="Resources/Plots.PNG" /></p>
<h3 id="additional-finds">Additional Finds</h3>
<ul>
<li>If the kit circuit starts to beep and blinks yellow, replace the batteries inside the gokart kit</li>
<li>If for some reason, nothing in the kit seems to work and the kit beeps and blinks most likely it is because the ground between the gokart kit and segway has lost connection</li>
<li>If everything seems to be correct put together and is not related to anything mentioned above, it is probably a connector in the gokart kit circuit that is loose. See picture below</li>
</ul>
<p><img alt="Resources/gokart_circuit.jpg" src="Resources/gokart_circuit.jpg" /></p>
<h3 id="how-to-use-on-the-next-generation-platform">How to use on the next Generation Platform</h3>
<p>From previous analysis on Generation 3 Platform, they simple bypassed the pedals by wiring in a circuit in parallel with the pedals. Thereby having the functionality still left in the pedals. This is a solution that seems to work good enough, however a couple of things could be improved such as more intuitive program and also implementing a reverse function.</p>
<p>Another approach could be to use the serial communication to read and send signals on the bus. This method was found to be poorly approach because when we analyzed the communication (see specific folder) it was concluded that without a protocol it would simple just take to much time to decode the data sent.</p>
<p>Hamid: Future work: Decode the protocol and read the speed data from there instead of separate speedsensor.</p>
<h3 id="proof-of-concept">Proof Of Concept</h3>
<p>It was assumed that we just could reverse the pins from the setup whilst reading the pedals (see section Analysis on Ninebot). However since arduinos analog outputs are simplified thourgh PWM signals, the gokart circuit started to complain about the input signals.</p>
<p>In order to debug the problem and verify that it was the PWM signals that caused the error, a <em>National Instrument Controller</em> that can output pure analog signals. Then it was verified that the issue was because of the arduinos PWM approximation and the gokart could move and pedals still worked along the instrument, <a href="https://drive.google.com/file/d/1D2tYhCP_eQu2Ao0KFW6zust-HcUzTzyf/view?usp=sharing">Demo Video</a>. It also proofs the concept of using analog signals to control the propulsion and maintaining the pedals function.</p>
<p>Then by using a Digital-To-Analog converter (DAC) it would be possible to accurately control the propulsion through any type of micro-controller.</p>
<h3 id="test-rig-to-verify-functionality">Test Rig To Verify Functionality</h3>
<p>In order to simply test the functionality of the propulsion control a simple local test rig was set up.</p>
<h3 id="set-up-and-hardware">Set Up and Hardware</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>SW Library</th>
<th>Manual Path</th>
</tr>
</thead>
<tbody>
<tr>
<td>mcp4725-12-bit-dac</td>
<td>https://github.com/adafruit/Adafruit_MCP4725</td>
<td><code>~\Documentation\Segway_Propulsion\Manuals</code></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align: center;"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="Resources/wiring_doc_DAC.PNG" src="Resources/wiring_doc_DAC.PNG" /></td>
</tr>
<tr>
<td style="text-align: center;">Fig: From manual on MCP4725</td>
</tr>
</tbody>
</table>
<p>DAC also has the capability to easily add one more board in parallel, so a total of 2 boards can be used on the same IC^2 bus. The additional MCP4725 library also needs the Adafruit busIO, the later one manage the bus communication easily and userfriendly. So the only neccesary pseudo code in order to operate the MCP4725 DAC becomes:</p>
<pre><code class="language-c">#include &lt;Wire.h&gt;
#include &lt;Adafruit_MCP4725.h&gt;
Adafruit_MCP4725 dac1; // instance of the class Adafruit_MCP4725 for one board
Adafruit_MCP4725 dac2; // instance of the class Adafruit_MCP4725 for second board
void setup() {
  Serial.begin(9600);
  dac1.begin(0x62); // communication addres for dac1, using same I2C bus!
  dac2.begin(0x63); // communication addres for dac2, using same I2C bus!
}
void loop() {
   dac1.setVoltage(some_value, false); // sets the reference voltage on dac1
   dac2.setVoltage(some_value, false); // sets the reference voltage on dac2
}
</code></pre>
<p>Operating voltage is 2.7-5.5 V which is determined by the supply voltage V_DD. Since the DAC's reference value is set by 12 bits, resulting in a resolution on 4096 relative gnd and V_DD. The relationship can be described accordingly:</p>
<p>$$ V_{out} = { V_{DD} \cdot D_{ref} \over 4096 } $$</p>
<p>Where $D_{ref}$ is a value from 0 up to 4096. The equation then can be rewritten, to make the code more intuitive and user-friendly and the pass by value to use in <em>DAC.setVoltage</em> function will then be:</p>
<p>$$ D_{set} =  V_{set}   \frac{4096}{V_{DD}} = V_{set} D_{dac-scaling}$$</p>
<p>Other components was a available Arduino Mega and a oscilloscope to measure the signals. The setup consist of 2 different rigs.</p>
<ol>
<li><strong>DAC rig</strong>, measuring the DAC output voltage using the oscilloscope.</li>
<li><strong>Ninebot rig</strong>, using the DAC boards in parallell to the Ninebot pedals.</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>DAC Rig</strong>  Wiring</th>
<th style="text-align: center;"><strong>Ninebot</strong> Wiring</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="Resources/DAC_setup.jpg" src="Resources/DAC_setup.jpg" /></td>
<td style="text-align: center;"><img alt="Resources/Ninebot_wiring.jpg" src="Resources/Ninebot_wiring.jpg" /></td>
</tr>
</tbody>
</table>
<h3 id="results">Results</h3>
<p>The test rigs software can be found in <code>~\autonomous_platform\Documentation\Segway_Propulsion\Test_Rig</code>.</p>
<table>
<thead>
<tr>
<th style="text-align: center;">DAC Rig Results</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="Resources/DAC_Digital.jpg" src="Resources/DAC_Digital.jpg" /></td>
</tr>
<tr>
<td style="text-align: center;"><strong>Fig</strong>: Comparison between the regular digtal output pin (yellow on Channel 1) and the output voltage from the DAC (blue channel 2</td>
</tr>
<tr>
<td style="text-align: center;"><img alt="Resources/DAC_triangle.jpg" src="Resources/DAC_triangle.jpg" /></td>
</tr>
<tr>
<td style="text-align: center;"><strong>Fig</strong>: It is also possible to generate complex signals such as a triangle wave. Now DAC output on channel 1</td>
</tr>
<tr>
<td style="text-align: center;"><img alt="Resources/DAC_sin.jpg" src="Resources/DAC_sin.jpg" /></td>
</tr>
<tr>
<td style="text-align: center;"><strong>Fig</strong>: Furthermore it is also possible to generate sinusoidal signals.</td>
</tr>
</tbody>
</table>
<p>As the ninebot circuit needs pure analog voltages and not the PWM approximations, the solution whilst using a DAC seems suitable. One other thing noted is that the arduino's analog pin output, cant be controlled in the same manner, as it can only be 0V or 5V. Furthermore with DAC board, arbritary microcontroller can be used.</p>
<table>
<thead>
<tr>
<th style="text-align: center;">Ninebot Rig Results</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="Resources/reverse_meas.PNG" src="Resources/reverse_meas.PNG" /></td>
</tr>
<tr>
<td style="text-align: center;"><strong>Fig:</strong> Whilst doing the testing on DAC with ninebot, we also measured the voltages in each cable, the x-axis in scaled over milli seconds (ms). In order to define the reverse algorithm, it was simply set up to measure signals whilst pressing the pedals manually (2 times rapidly to go into reverse mode). Making it possible to approximate the time constant needed between the presses, $\tau=200$ ms.</td>
</tr>
<tr>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;"><a href="https://drive.google.com/file/d/1FeQGeAu96iMUcdyh7bQluNmk0nlNBufs/view?usp=share_link">Demo video, demostrating the functionality to control the propulsion using the DAC board.</a></td>
</tr>
<tr>
<td style="text-align: center;"><strong>Comments:</strong> In the video it is demostrated how the ninebot can accelerate, break and go into reverse mode whilst only controlling the DAC board. Further simple algorithms that has been implemented consist of ramping up the speed from 0 to max and respectively ramping down from max to 0.</td>
</tr>
<tr>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;"><a href="https://drive.google.com/file/d/1LnbnqobhJgI2CLCRH9k_zDKZqvCopJJC/view?usp=share_link">Demo video, demostrating the functionality to use the pedals at the same time as the DAC board</a></td>
</tr>
<tr>
<td style="text-align: center;"><strong>Comments:</strong> In the video it is demonstrated how it is still possible to use the pedals to break whilst the DAC are engaged.</td>
</tr>
</tbody>
</table>
<h3 id="conclusion-and-future-work">Conclusion and future work</h3>
<p>The test rigs was a great success and validates the proposed solution to simply generate analog voltages in order to control the velocity of the Ninebot.</p>
<p>Future development is to implement accurate and robust speed sensors in order to have a feedback system or even some kind of PI-controller. Also to finalize the local code for the node, with some more features. Furthermore also when the first physical modular node has been developed/printed implement the propulsion control on the bluepill and connect to the node with CAN bus to send/read signals.</p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../../..";</script>
    <script src="../../../../js/theme_extra.js"></script>
    <script src="../../../../js/theme.js"></script>
      <script src="../../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
